<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Portofolio Unified</title>
    <style>
        body { font-family: sans-serif; padding: 0; margin: 0; background: #f4f4f4; display: flex; height: 100vh; overflow: hidden; }
        
        /* --- SIDEBAR --- */
        .sidebar { width: 260px; background: #2c3e50; color: white; display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 20px; background: #1a252f; text-align: center; }
        .sidebar-header h2 { margin: 0; font-size: 1.2rem; border: none; padding: 0; color: white; }
        
        .sidebar button { padding: 15px 20px; background: transparent; color: #ecf0f1; border: none; border-radius: 0; cursor: pointer; text-align: left; width: 100%; margin: 0; transition: background 0.2s; border-bottom: 1px solid #34495e; font-size: 16px; }
        .sidebar button:hover { background: #34495e; }
        .sidebar button.active { background: #0066cc; border-left: 5px solid #3498db; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        input, select { margin-bottom: 10px; width: 300px; padding: 8px; }
        
        /* Tombol di dalam konten utama */
        .main-content button { padding: 10px 20px; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px; }
        .main-content button:hover { background: #0052a3; }
        .main-content button.cancel { background: #777; }
        .main-content button.delete { background: #c33; }
        
        .preview-img { width: 200px; display: none; margin-top: 10px; border-radius: 5px; }
        .upload-form { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        
        .success-message { color: green; margin-top: 10px; display: block; }
        .error-message { color: red; margin-top: 10px; display: block; }
        
        .progress { display: none; width: 100%; height: 20px; background: #eee; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: #0066cc; width: 0%; transition: width 0.3s; }

        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .gallery-item { border: 1px solid #ddd; padding: 10px; border-radius: 12px; background: white; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .gallery-img-container { width: 100%; height: 200px; overflow: hidden; border-radius: 8px; background: #f9f9f9; margin-bottom: 10px; }
        .gallery-img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-title { font-size: 14px; margin: 10px 0 5px 0; color: #333; word-break: break-word; }
        .action-buttons { display: flex; gap: 8px; justify-content: center; margin-top: 8px; }

        /* --- DASHBOARD STYLES --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 3rem; font-weight: bold; color: #0066cc; margin: 10px 0; }
        .stat-label { color: #666; font-size: 1.1rem; }
        .recent-list { list-style: none; padding: 0; }
        .recent-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .recent-item:last-child { border-bottom: none; }
        .recent-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 15px; background: #eee; }
        .recent-info { flex: 1; overflow: hidden; }
        .recent-title { font-weight: bold; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .recent-meta { font-size: 0.85rem; color: #888; }

        /* Checkbox Style */
        .bulk-check { position: absolute; top: 15px; left: 15px; transform: scale(1.5); cursor: pointer; z-index: 10; accent-color: #0066cc; }

        /* --- LIVE PREVIEW MODAL --- */
        .live-preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(4px); animation: fadeIn 0.3s; }
        .live-preview-content { width: 90%; height: 90%; background: white; border-radius: 12px; overflow: hidden; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        .live-preview-header { padding: 12px 20px; background: #2c3e50; display: flex; justify-content: space-between; align-items: center; color: white; }
        .live-preview-title { font-size: 16px; font-weight: bold; letter-spacing: 1px; }
        .live-preview-content iframe { width: 100%; flex: 1; border: none; background: white; }
        .close-preview-btn { background: #e74c3c; color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.2s; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .close-preview-btn:hover { background: #c0392b; transform: translateY(-1px); }
        .close-preview-btn:active { transform: translateY(0); }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Antipost Dashboard</h2>
        </div>
        <button onclick="switchTab('dashboard')" id="btn-dashboard" class="active">üìä Dashboard</button>
        <button onclick="switchTab('personal')" id="btn-personal">üìÇ Personal Works</button>
        <button onclick="switchTab('cw')" id="btn-cw">üíº Comission Works</button>
        <button onclick="switchTab('settings')" id="btn-settings">‚öôÔ∏è Settings</button>
        <button onclick="openLivePreview()" id="btn-live-preview">üëÅÔ∏è Live Preview</button>
        <button onclick="window.location.href='/logout'" style="margin-top: auto; border-top: 1px solid #34495e;">üö™ Logout</button>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div class="main-content">

    <!-- ==================== DASHBOARD SECTION ==================== -->
    <div id="tab-dashboard" class="tab-content active">
        <div class="card">
            <h2>üìä Dashboard Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Personal Works</div>
                    <div class="stat-number" id="stat-personal-count">...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Comission Works</div>
                    <div class="stat-number" id="stat-cw-count">...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üïí Recent Activity</h2>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <h3>Newest Personal Works</h3>
                    <ul class="recent-list" id="recent-personal-list">
                        <li>Loading...</li>
                    </ul>
                </div>
                <div style="flex: 1; min-width: 300px;">
                    <h3>Newest Comission Works</h3>
                    <ul class="recent-list" id="recent-cw-list">
                        <li>Loading...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== PERSONAL WORKS SECTION ==================== -->
    <div id="tab-personal" class="tab-content">
        <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">
            <h2 style="border: none; padding: 0; margin: 0;">üì§ PERSONAL WORKS</h2>
            <button class="delete" onclick="handleBulkDelete('personal')">üóëÔ∏è Delete Selected</button>
        </div>
        <div class="upload-form">
            <input type="hidden" id="personalId" />
            <input type="hidden" id="personalImageUrl" />
            <input type="hidden" id="personalPublicId" />
            <input type="text" id="personalNameInput" placeholder="TITLE (Personal)" />
            <input type="file" id="personalFileInput" accept="image/*" />
            <button id="personalUploadBtn" onclick="handlePersonalSubmit()">Upload</button>
            <button id="personalCancelBtn" class="cancel" style="display:none;" onclick="cancelPersonal()">Cancel</button>
        </div>
        <div class="progress" id="personalProgress">
            <div class="progress-bar" id="personalProgressBar"></div>
        </div>
        <p id="personalStatus"></p>
        <img id="personalPreview" class="preview-img" src="" alt="Preview">
    </div>

    <div class="card">
        <h2>Gallery ‚Äî PERSONAL WORKS</h2>
        <div id="personalGallery" class="gallery-grid">
            <p>Memuat data...</p>
        </div>
        </div>
    </div>

    <!-- ==================== COMISSION WORKS SECTION ==================== -->
    <div id="tab-cw" class="tab-content">
        <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">
            <h2 style="border: none; padding: 0; margin: 0;">üì§ COMISSION WORKS</h2>
            <button class="delete" onclick="handleBulkDelete('commission')">üóëÔ∏è Delete Selected</button>
        </div>
        <div class="upload-form">
            <input type="hidden" id="cwId" />
            <input type="hidden" id="cwImageUrl" />
            <input type="hidden" id="cwPublicId" />
            <input type="text" id="cwTitleInput" placeholder="TITLE (Comission)" />
            <input type="file" id="cwFileInput" accept="image/*" />
            <button id="cwUploadBtn" onclick="handleComissionSubmit()">Upload</button>
            <button id="cwCancelBtn" class="cancel" style="display:none;" onclick="cancelComission()">Cancel</button>
        </div>
        <div class="progress" id="cwProgress">
            <div class="progress-bar" id="cwProgressBar"></div>
        </div>
        <p id="cwStatus"></p>
        <img id="cwPreview" class="preview-img" src="" alt="Preview">
    </div>

    <div class="card">
        <h2>Gallery ‚Äî COMISSION WORKS</h2>
        <div id="cwGallery" class="gallery-grid">
            <p>Memuat data...</p>
        </div>
        </div>
    </div>

    <!-- ==================== SETTINGS SECTION ==================== -->
    <div id="tab-settings" class="tab-content">
        <div class="card">
            <h2>üîê Change Password</h2>
            <div style="max-width: 400px;">
                <input type="password" id="oldPassInput" placeholder="Password Lama" style="width: 100%; box-sizing: border-box; margin-bottom: 10px;" />
                <input type="password" id="newPassInput" placeholder="Password Baru" style="width: 100%; box-sizing: border-box; margin-bottom: 10px;" />
                <button onclick="handleChangePassword()">Update Password</button>
            </div>
            <p id="settingsStatus"></p>
        </div>
        <div class="card">
            <h2>üî¢ Change PIN</h2>
            <div style="max-width: 400px;">
                <input type="password" id="oldPinInput" placeholder="PIN Lama" style="width: 100%; box-sizing: border-box; margin-bottom: 10px;" pattern="[0-9]*" inputmode="numeric" />
                <input type="password" id="newPinInput" placeholder="PIN Baru" style="width: 100%; box-sizing: border-box; margin-bottom: 10px;" pattern="[0-9]*" inputmode="numeric" />
                <button onclick="handleChangePin()">Update PIN</button>
            </div>
            <p id="pinStatus"></p>
        </div>
        <div class="card">
            <h2>üíß Watermark Settings</h2>
            <div style="max-width: 400px;">
                <input type="text" id="wmTextInput" placeholder="Watermark Text (e.g. ANTIPOST)" style="width: 100%; box-sizing: border-box; margin-bottom: 10px;" />
                <button onclick="handleUpdateWm()">Update Watermark</button>
            </div>
            <p id="wmStatus"></p>
        </div>
    </div>

    </div> <!-- End .main-content -->

    <!-- LIVE PREVIEW MODAL -->
    <div id="live-preview-modal" class="live-preview-modal">
        <div class="live-preview-content">
            <div class="live-preview-header">
                <span class="live-preview-title">WEBSITE LIVE PREVIEW</span>
                <button class="close-preview-btn" onclick="closeLivePreview()">‚úï TUTUP</button>
            </div>
            <iframe id="live-preview-frame" src=""></iframe>
        </div>
    </div>

    <script>
        // --- CONFIG & UTILS ---

        function switchTab(tabName) {
            // Sembunyikan semua tab
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // Tampilkan tab yang dipilih
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Update status tombol sidebar
            document.querySelectorAll('.sidebar button').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-' + tabName).classList.add('active');
        }
        
        // Fungsi Upload Generic (bisa dipakai Personal & Comission)
        function uploadFile(file, progressBarElement, progressContainer) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('image', file);

                const xhr = new XMLHttpRequest();
                
                if (progressContainer) progressContainer.style.display = 'block';
                if (progressBarElement) progressBarElement.style.width = '0%';

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable && progressBarElement) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressBarElement.style.width = percentComplete + '%';
                    }
                });

                xhr.addEventListener('load', () => {
                    if (progressContainer) progressContainer.style.display = 'none';
                    if (xhr.status === 200) {
                        try {
                            const result = JSON.parse(xhr.responseText);
                            resolve(result);
                        } catch (e) {
                            reject(new Error('Gagal parsing response: ' + e.message));
                        }
                    } else {
                        reject(new Error(xhr.responseText || 'Upload failed'));
                    }
                });

                xhr.addEventListener('error', () => {
                    if (progressContainer) progressContainer.style.display = 'none';
                    reject(new Error('Network error'));
                });

                xhr.open('POST', '/upload');
                xhr.send(formData);
            });
        }

        function escapeHtml(s) { 
            return String(s || '').replace(/[&<>\"']/g, c => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[c]); 
        }

        function getImgSrc(path, folder) {
            if (!path) return 'https://via.placeholder.com/200?text=No+Image';
            if (path.startsWith('http')) return path;
            return `/images/${folder}/${path}`;
        }

        // --- DASHBOARD LOGIC ---
        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats');
                const data = await res.json();
                
                document.getElementById('stat-personal-count').textContent = data.counts.personals;
                document.getElementById('stat-cw-count').textContent = data.counts.comission_works;

                const renderList = (items, elementId, folder) => {
                    const list = document.getElementById(elementId);
                    if (!items || !items.length) { list.innerHTML = '<li>No recent items</li>'; return; }
                    list.innerHTML = items.map(item => `
                        <li class="recent-item">
                            <img src="${getImgSrc(item.image_path, folder)}" class="recent-thumb" onerror="this.src='https://via.placeholder.com/50'">
                            <div class="recent-info">
                                <span class="recent-title">${escapeHtml(item.name || item.title)}</span>
                                <span class="recent-meta">ID: ${item.id}</span>
                            </div>
                        </li>
                    `).join('');
                };

                renderList(data.recent.personals, 'recent-personal-list', 'personals');
                renderList(data.recent.comission_works, 'recent-cw-list', 'comission_works');
            } catch (e) {
                console.error("Failed to load stats:", e);
            }
        }

        // --- PERSONAL WORKS LOGIC ---

        async function handlePersonalSubmit() {
            const name = document.getElementById('personalNameInput').value.trim();
            const fileInput = document.getElementById('personalFileInput');
            const id = document.getElementById('personalId').value || null;
            const existingUrl = document.getElementById('personalImageUrl').value;
            const existingPublicId = document.getElementById('personalPublicId').value;
            const status = document.getElementById('personalStatus');
            const progress = document.getElementById('personalProgress');
            const progressBar = document.getElementById('personalProgressBar');

            if (!name) {
                status.innerHTML = '<span class="error-message">‚ö†Ô∏è Judul wajib diisi!</span>';
                return;
            }

            // Edit tanpa ganti gambar
            if (id && !fileInput.files.length) {
                await savePersonalToDB(id, name, existingUrl, existingPublicId);
                return;
            }

            // Harus ada file jika buat baru
            if (!id && !fileInput.files.length) {
                status.innerHTML = '<span class="error-message">‚ö†Ô∏è Pilih gambar dulu!</span>';
                return;
            }

            // Upload gambar baru
            try {
                status.innerHTML = '<span>üîÑ Uploading...</span>';
                const uploadRes = await uploadFile(fileInput.files[0], progressBar, progress);
                await savePersonalToDB(id, name, uploadRes.imageUrl, uploadRes.public_id);
            } catch (err) {
                console.error(err);
                status.innerHTML = `<span class="error-message">‚ùå Error: ${err.message}</span>`;
            }
        }

        async function savePersonalToDB(id, name, imageUrl, publicId) {
            const status = document.getElementById('personalStatus');
            try {
                const url = id ? `/api/personals/${id}` : '/api/personals';
                const method = id ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        image_path: imageUrl,
                        public_id: publicId,
                        description: 'Uploading.....'
                    })
                });

                if (!res.ok) throw new Error('Gagal menyimpan ke database');
                
                status.innerHTML = '<span class="success-message">‚úÖ Berhasil disimpan!</span>';
                cancelPersonal(); // Reset form
                loadPersonals();
            } catch (err) {
                console.error(err);
                status.innerHTML = `<span class="error-message">‚ùå DB Error: ${err.message}</span>`;
            }
        }

        async function loadPersonals() {
            try {
                const res = await fetch('/api/personals');
                const data = await res.json();
                const gallery = document.getElementById('personalGallery');
                
                if (!data.length) { gallery.innerHTML = '<p>Belum ada data.</p>'; return; }

                gallery.innerHTML = data.map(item => `
                    <div class="gallery-item">
                        <input type="checkbox" class="bulk-check bulk-personal" value="${item.id}">
                        <div class="gallery-img-container">
                            <img src="${getImgSrc(item.image_path, 'personals')}" class="gallery-img" onerror="this.src='https://via.placeholder.com/200'">
                        </div>
                        <h3 class="gallery-title">${escapeHtml(item.name)}</h3>
                        <div class="action-buttons">
                            <button onclick="editPersonal(${item.id})">Edit</button>
                            <button class="delete" onclick="deletePersonal(${item.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) { console.error(err); }
        }

        async function editPersonal(id) {
            try {
                const res = await fetch(`/api/personals/${id}`);
                const data = await res.json();
                
                document.getElementById('personalId').value = data.id;
                document.getElementById('personalNameInput').value = data.name;
                document.getElementById('personalImageUrl').value = data.image_path;
                document.getElementById('personalPublicId').value = data.public_id || '';
                
                const preview = document.getElementById('personalPreview');
                preview.src = getImgSrc(data.image_path, 'personals');
                preview.style.display = 'block';

                document.getElementById('personalUploadBtn').textContent = 'Update';
                document.getElementById('personalCancelBtn').style.display = 'inline-block';
                document.getElementById('personalStatus').innerHTML = '<span>üîÑ Mode Edit</span>';
                document.querySelector('.main-content').scrollTo({ top: 0, behavior: 'smooth' });
            } catch (err) { alert('Gagal memuat data'); }
        }

        function cancelPersonal() {
            document.getElementById('personalId').value = '';
            document.getElementById('personalNameInput').value = '';
            document.getElementById('personalImageUrl').value = '';
            document.getElementById('personalPublicId').value = '';
            document.getElementById('personalFileInput').value = '';
            document.getElementById('personalPreview').style.display = 'none';
            document.getElementById('personalUploadBtn').textContent = 'Upload';
            document.getElementById('personalCancelBtn').style.display = 'none';
            document.getElementById('personalStatus').innerHTML = '';
        }

        async function deletePersonal(id) {
            if (!confirm('Hapus item ini?')) return;
            try {
                await fetch(`/api/personals/${id}`, { method: 'DELETE' });
                loadPersonals();
            } catch (err) { alert('Gagal menghapus'); }
        }

        // --- COMISSION WORKS LOGIC ---

        async function handleComissionSubmit() {
            const title = document.getElementById('cwTitleInput').value.trim();
            const fileInput = document.getElementById('cwFileInput');
            const id = document.getElementById('cwId').value || null;
            const existingUrl = document.getElementById('cwImageUrl').value;
            const existingPublicId = document.getElementById('cwPublicId').value;
            const status = document.getElementById('cwStatus');
            const progress = document.getElementById('cwProgress');
            const progressBar = document.getElementById('cwProgressBar');

            if (!title) {
                status.innerHTML = '<span class="error-message">‚ö†Ô∏è Judul wajib diisi!</span>';
                return;
            }

            if (id && !fileInput.files.length) {
                await saveComissionToDB(id, title, existingUrl, existingPublicId);
                return;
            }

            if (!id && !fileInput.files.length) {
                status.innerHTML = '<span class="error-message">‚ö†Ô∏è Pilih gambar dulu!</span>';
                return;
            }

            try {
                status.innerHTML = '<span>üîÑ Uploading...</span>';
                const uploadRes = await uploadFile(fileInput.files[0], progressBar, progress);
                await saveComissionToDB(id, title, uploadRes.imageUrl, uploadRes.public_id);
            } catch (err) {
                console.error(err);
                status.innerHTML = `<span class="error-message">‚ùå Error: ${err.message}</span>`;
            }
        }

        async function saveComissionToDB(id, title, imageUrl, publicId) {
            const status = document.getElementById('cwStatus');
            try {
                const url = id ? `/api/comission_works/${id}` : '/api/comission_works';
                const method = id ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        image_path: imageUrl,
                        public_id: publicId,
                        description: null
                    })
                });

                if (!res.ok) throw new Error('Gagal menyimpan ke database');
                
                status.innerHTML = '<span class="success-message">‚úÖ Berhasil disimpan!</span>';
                cancelComission();
                loadComissions();
            } catch (err) {
                console.error(err);
                status.innerHTML = `<span class="error-message">‚ùå DB Error: ${err.message}</span>`;
            }
        }

        async function loadComissions() {
            try {
                const res = await fetch('/api/comission_works');
                const data = await res.json();
                const gallery = document.getElementById('cwGallery');
                
                if (!data.length) { gallery.innerHTML = '<p>Belum ada data.</p>'; return; }

                gallery.innerHTML = data.map(item => `
                    <div class="gallery-item">
                        <input type="checkbox" class="bulk-check bulk-commission" value="${item.id}">
                        <div class="gallery-img-container">
                            <img src="${getImgSrc(item.image_path, 'comission_works')}" class="gallery-img" onerror="this.src='https://via.placeholder.com/200'">
                        </div>
                        <h3 class="gallery-title">${escapeHtml(item.title)}</h3>
                        <div class="action-buttons">
                            <button onclick="editComission(${item.id})">Edit</button>
                            <button class="delete" onclick="deleteComission(${item.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) { console.error(err); }
        }

        async function editComission(id) {
            try {
                const res = await fetch(`/api/comission_works/${id}`);
                const data = await res.json();
                
                document.getElementById('cwId').value = data.id;
                document.getElementById('cwTitleInput').value = data.title;
                document.getElementById('cwImageUrl').value = data.image_path;
                document.getElementById('cwPublicId').value = data.public_id || '';
                
                const preview = document.getElementById('cwPreview');
                preview.src = getImgSrc(data.image_path, 'comission_works');
                preview.style.display = 'block';

                document.getElementById('cwUploadBtn').textContent = 'Update';
                document.getElementById('cwCancelBtn').style.display = 'inline-block';
                document.getElementById('cwStatus').innerHTML = '<span>üîÑ Mode Edit</span>';
                
                // Scroll ke form comission
                document.querySelector('.main-content').scrollTo({ top: 0, behavior: 'smooth' });
            } catch (err) { alert('Gagal memuat data'); }
        }

        function cancelComission() {
            document.getElementById('cwId').value = '';
            document.getElementById('cwTitleInput').value = '';
            document.getElementById('cwImageUrl').value = '';
            document.getElementById('cwPublicId').value = '';
            document.getElementById('cwFileInput').value = '';
            document.getElementById('cwPreview').style.display = 'none';
            document.getElementById('cwUploadBtn').textContent = 'Upload';
            document.getElementById('cwCancelBtn').style.display = 'none';
            document.getElementById('cwStatus').innerHTML = '';
        }

        async function deleteComission(id) {
            if (!confirm('Hapus item ini?')) return;
            try {
                await fetch(`/api/comission_works/${id}`, { method: 'DELETE' });
                loadComissions();
            } catch (err) { alert('Gagal menghapus'); }
        }

        // --- BULK DELETE LOGIC ---
        async function handleBulkDelete(category) {
            // Tentukan class checkbox berdasarkan kategori
            const className = category === 'personal' ? '.bulk-personal' : '.bulk-commission';
            const checkboxes = document.querySelectorAll(`${className}:checked`);
            
            if (checkboxes.length === 0) {
                alert('Pilih minimal satu item untuk dihapus.');
                return;
            }

            if (!confirm(`Yakin ingin menghapus ${checkboxes.length} item yang dipilih?`)) return;

            const ids = Array.from(checkboxes).map(cb => cb.value);

            try {
                const res = await fetch('/api/admin/bulk-delete', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids, category })
                });
                const result = await res.json();
                if (result.success) {
                    // Reload data sesuai kategori
                    category === 'personal' ? loadPersonals() : loadComissions();
                    loadStats(); // Update dashboard stats juga
                } else {
                    alert('Gagal menghapus: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                console.error(err);
                alert('Terjadi kesalahan saat menghubungi server.');
            }
        }

        // --- INIT ---
        window.addEventListener('load', () => {
            loadStats();
            loadWmConfig(); // Load watermark setting saat halaman dibuka
            loadPersonals();
            loadComissions();

            // Validasi Ukuran File (Max 10MB)
            ['personalFileInput', 'cwFileInput'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', function() {
                        if (this.files[0] && this.files[0].size > 50 * 1024 * 1024) {
                            alert('Ukuran file maksimal 50MB untuk akun gratis');
                            this.value = '';
                        }
                    });
                }
            });
        });

        async function loadWmConfig() {
            try {
                const res = await fetch('/api/wm-config');
                const data = await res.json();
                if(data.wm_text) document.getElementById('wmTextInput').value = data.wm_text;
            } catch(e) { console.error(e); }
        }

        // --- SETTINGS LOGIC ---
        async function handleChangePassword() {
            const oldPass = document.getElementById('oldPassInput').value;
            const newPass = document.getElementById('newPassInput').value;
            const status = document.getElementById('settingsStatus');

            if (!oldPass || !newPass) {
                status.innerHTML = '<span class="error-message">‚ö†Ô∏è Mohon isi kedua kolom password.</span>';
                return;
            }

            status.innerHTML = '<span>üîÑ Memproses...</span>';

            try {
                const res = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldPassword: oldPass, newPassword: newPass })
                });
                const data = await res.json();

                if (data.success) {
                    status.innerHTML = '<span class="success-message">‚úÖ Password berhasil diubah!</span>';
                    document.getElementById('oldPassInput').value = '';
                    document.getElementById('newPassInput').value = '';
                } else {
                    status.innerHTML = `<span class="error-message">‚ùå ${data.message}</span>`;
                }
            } catch (err) {
                status.innerHTML = '<span class="error-message">‚ùå Gagal menghubungi server.</span>';
            }
        }

        async function handleChangePin() {
            const oldPin = document.getElementById('oldPinInput').value;
            const newPin = document.getElementById('newPinInput').value;
            const status = document.getElementById('pinStatus');

            if (!oldPin || !newPin) {
                status.innerHTML = '<span class="error-message">‚ö†Ô∏è Mohon isi kedua kolom PIN.</span>';
                return;
            }

            status.innerHTML = '<span>üîÑ Memproses...</span>';

            try {
                const res = await fetch('/api/change-pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldPin: oldPin, newPin: newPin })
                });
                const data = await res.json();

                if (data.success) {
                    status.innerHTML = '<span class="success-message">‚úÖ PIN berhasil diubah!</span>';
                    document.getElementById('oldPinInput').value = '';
                    document.getElementById('newPinInput').value = '';
                } else {
                    status.innerHTML = `<span class="error-message">‚ùå ${data.message}</span>`;
                }
            } catch (err) {
                status.innerHTML = '<span class="error-message">‚ùå Gagal menghubungi server.</span>';
            }
        }

        async function handleUpdateWm() {
            const text = document.getElementById('wmTextInput').value;
            const status = document.getElementById('wmStatus');
            
            status.innerHTML = '<span>üîÑ Saving...</span>';
            try {
                const res = await fetch('/api/admin/update-wm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wm_text: text })
                });
                const data = await res.json();
                if (data.success) {
                    status.innerHTML = '<span class="success-message">‚úÖ Watermark updated!</span>';
                } else {
                    status.innerHTML = `<span class="error-message">‚ùå ${data.message}</span>`;
                }
            } catch (e) {
                console.error(e);
                status.innerHTML = '<span class="error-message">‚ùå Error saving watermark.</span>';
            }
        }

        // --- LIVE PREVIEW LOGIC ---
        function openLivePreview() {
            const modal = document.getElementById('live-preview-modal');
            const iframe = document.getElementById('live-preview-frame');
            iframe.src = '/'; // Refresh content
            modal.style.display = 'flex';
        }

        function closeLivePreview() {
            document.getElementById('live-preview-modal').style.display = 'none';
            document.getElementById('live-preview-frame').src = ''; // Stop loading
        }
    </script>
</body>
</html>
